<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Lost in translation - Remix edition | joelazar&#39;s personal blog</title>
<meta name="keywords" content="remix, typescript, network, JSON">
<meta name="description" content="Receive the right data from your server in Remix">
<meta name="author" content="József Gábor Lázár">
<link rel="canonical" href="https://joelazar.dev/posts/lost-in-translation/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://joelazar.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://joelazar.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://joelazar.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://joelazar.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://joelazar.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://joelazar.dev/posts/lost-in-translation/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZCXTR8Q2K"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FZCXTR8Q2K');
        }
      </script><meta property="og:title" content="Lost in translation - Remix edition" />
<meta property="og:description" content="Receive the right data from your server in Remix" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://joelazar.dev/posts/lost-in-translation/" />
<meta property="og:image" content="https://joelazar.dev/profile.jpg" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-22T08:00:00+01:00" />
<meta property="article:modified_time" content="2022-08-22T08:00:00+01:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://joelazar.dev/profile.jpg" />
<meta name="twitter:title" content="Lost in translation - Remix edition"/>
<meta name="twitter:description" content="Receive the right data from your server in Remix"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://joelazar.dev/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Lost in translation - Remix edition",
      "item": "https://joelazar.dev/posts/lost-in-translation/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lost in translation - Remix edition",
  "name": "Lost in translation - Remix edition",
  "description": "Receive the right data from your server in Remix",
  "keywords": [
    "remix", "typescript", "network", "JSON"
  ],
  "articleBody": "Last week I made a ⚡️ talk at Remix Copenhagen meetup. I thought I make a short blog post about the content if I already gather the material for it.\nThere is a mistake in this code. Can you find it? 🔍 import type { Note } from '@prisma/client'; import { useCatch, useLoaderData } from '@remix-run/react'; import type { LoaderFunction } from '@remix-run/server-runtime'; import { json } from '@remix-run/server-runtime'; import { prisma } from '~/db.server'; /* export type Note = { id: string title: string body: string createdAt: Date updatedAt: Date } */ type LoaderData = { notes: Note[]; }; export const loader: LoaderFunction = async () =\u003e { const notes = await prisma.note.findMany({}); return json({ notes }); }; export default function Problem() { const { notes } = useLoaderData\u003cLoaderData\u003e(); return ( \u003c\u003e {notes.map((note) =\u003e ( \u003cdiv key={note.id} className=\"p flex flex-auto flex-col p-4 sm:p-6 lg:p-8\" \u003e \u003ch2 className=\"text-2xl font-bold\"\u003e{note.title}\u003c/h2\u003e \u003cul className=\"text-lg\"\u003e \u003cli\u003e Created at: {Intl.DateTimeFormat('en-US').format(note.createdAt)} \u003c/li\u003e \u003cli\u003e Updated at: {Intl.DateTimeFormat('en-US').format(note.updatedAt)} \u003c/li\u003e \u003cli\u003eBody: {note.body}\u003c/li\u003e \u003c/ul\u003e \u003c/div\u003e ))} \u003c/\u003e ); } ⚠️ Solution The problem is with the following lines:\n\u003cli\u003e Created at: {Intl.DateTimeFormat(\"en-US\").format(note.createdAt)} \u003c/li\u003e \u003cli\u003e Updated at: {Intl.DateTimeFormat(\"en-US\").format(note.updatedAt)} \u003c/li\u003e Here, note.createdAt and note.updatedAt will have the type string instead of Date.\nExplanation 📜 At page navigation The client gets the code-split bundle for that page, and at time same time, the loader for that route gets evaluated, which is a Fetch request to the server. The response body of that request will be encoded in JSON, so it has to be serializable. Date and some other types don’t have a native JSON representation.\n┌────────────┐ ┌─────────────┐ │ 🖥️ ◄───code split bundle───┤ ☁️ │ │ browser ◄───data from loader────┤ server │ └────────────┘ └─────────────┘ At full reload A full reload on the same route will do a full server render, and the data will be just embedded in the HTML. Loaders will be evaluated on the server side, but the data still has to be serializable there too.\n┌────────────┐ ┌─────────────┐ │ 🖥️ ◄───full code bundle────┤ ☁️ │ │ browser ◄────prefilled html─────┤ server │ └────────────┘ └─────────────┘ OK types ✅ string ✅ number ✅ boolean ✅ null ✅ Array ✅ Object Problematic types ❌ Date ❌ BigInt ❌ Set ❌ Map ❌ RegExp ❌ undefined ❌ Error ❌ NaN At least we get a linter warning since remix 1.6.5 How to solve it - stupid solution Convert the strings to Dates. For this type, it will work fine, as the Date’s constructor accepts strings:\n\u003cli\u003e Created at: {Intl.DateTimeFormat(\"en-US\").format(new Date(note.createdAt))} \u003c/li\u003e \u003cli\u003e Updated at: {Intl.DateTimeFormat(\"en-US\").format(new Date(note.updatedAt))} \u003c/li\u003e However, there are types in which this method won’t work. We need a more generic solution for this.\nHow to solve it - the proper solution New features since remix 1.6.5 “We enhanced the type signatures of loader and useLoaderData to make it possible to infer the data type from the return type of its related server function. To enable this feature, you will need to use the LoaderArgs type from your Remix runtime package instead of typing the function directly:”\nimport type { LoaderFunction } from '@remix-run/[runtime]'; // --\u003e import type { LoaderArgs } from '@remix-run/[runtime]'; export const loader: LoaderFunction = async (args) =\u003e { return json\u003cLoaderData\u003e(data); }; // --\u003e export async function loader(args: LoaderArgs) { return json(data); } “Then you can infer the loader data by using typeof loader as the type variable in useLoaderData:\nlet data = useLoaderData() as LoaderData; // --\u003e let data = useLoaderData\u003ctypeof loader\u003e(); With this change, you no longer need to manually define a LoaderData type (huge time and typo saver!), and we serialize all values so that useLoaderData can’t return types that are impossible over the network, such as Date objects or functions.”\nReference: Remix 1.6.5 release note\nremix-typedjson Drop in replacement for useLoaderData/json calls –\u003e it will automatically convert your non-serializable types back and forth.\nconst loaderData = useLoaderData\u003ctypeof loader\u003e(); // --\u003e const loaderData = useTypedLoaderData\u003ctypeof loader\u003e(); and\nreturn json({...}) // --\u003e return typedjson({...}) Adding these two together:\nimport type { LoaderArgs } from '@remix-run/server-runtime'; import { typedjson, useTypedLoaderData } from 'remix-typedjson'; import { prisma } from '~/db.server'; export const loader = async (_: LoaderArgs) =\u003e { const notes = await prisma.note.findMany({}); return typedjson({ notes }); }; export default function Problem() { const { notes } = useTypedLoaderData\u003ctypeof loader\u003e(); return ( \u003c\u003e {notes.map((note) =\u003e ( \u003cdiv key={note.id} className=\"p flex flex-auto flex-col p-4 sm:p-6 lg:p-8\" \u003e \u003ch2 className=\"text-2xl font-bold \"\u003e{note.title}\u003c/h2\u003e \u003cul className=\"text-lg\"\u003e \u003cli\u003e Created at: {Intl.DateTimeFormat('en-US').format(note.createdAt)} \u003c/li\u003e \u003cli\u003e Updated at: {Intl.DateTimeFormat('en-US').format(note.updatedAt)} \u003c/li\u003e \u003cli\u003eBody: {note.body}\u003c/li\u003e \u003c/ul\u003e \u003c/div\u003e ))} \u003c/\u003e ); } This works now as we are sending a __meta__ object with the original JSON content, so on the client side the necessary data could be converted to the right type.\nWhat about other Remix API? Actions and fetchers are affected as well, but remix-typedjson handles them.\nconst actionData = useTypedActionData\u003ctypeof action\u003e(); and\nconst fetcher = useTypedFetcher\u003ctypeof action\u003e(); Could it be solved with superjson? Yes, of course.\nimport { deserialize, serialize } from \"superjson\"; ... export const loader: LoaderFunction = async () =\u003e { const notes = await prisma.note.findMany({}); return json(serialize({ notes })); }; export default function Problem() { const { notes } = deserialize( useLoaderData() as SuperJSONResult ) as LoaderData; ... } However, remix-typesjson’s API is much more comfortable to use, not to mention that it’s faster and more lightweight than superjson.\nLink for the presentation and code examples.\n",
  "wordCount" : "887",
  "inLanguage": "en",
  "image": "https://joelazar.dev/profile.jpg","datePublished": "2022-08-22T08:00:00+01:00",
  "dateModified": "2022-08-22T08:00:00+01:00",
  "author":{
    "@type": "Person",
    "name": "József Gábor Lázár"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://joelazar.dev/posts/lost-in-translation/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "joelazar's personal blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://joelazar.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://joelazar.dev/" accesskey="h" title="joelazar&#39;s personal blog (Alt + H)">joelazar&#39;s personal blog</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://joelazar.dev/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://joelazar.dev/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://joelazar.dev/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://joelazar.dev/">Home</a>&nbsp;»&nbsp;<a href="https://joelazar.dev/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Lost in translation - Remix edition
    </h1>
    <div class="post-description">
      Receive the right data from your server in Remix
    </div>
    <div class="post-meta"><span title='2022-08-22 08:00:00 +0100 +0100'>August 22, 2022</span>&nbsp;·&nbsp;József Gábor Lázár

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#there-is-a-mistake-in-this-code-can-you-find-it-" aria-label="There is a mistake in this code. Can you find it? 🔍">There is a mistake in this code. Can you find it? 🔍</a></li>
                <li>
                    <a href="#-solution" aria-label="⚠️ Solution">⚠️ Solution</a></li>
                <li>
                    <a href="#explanation-" aria-label="Explanation 📜">Explanation 📜</a><ul>
                        
                <li>
                    <a href="#at-page-navigation" aria-label="At page navigation">At page navigation</a></li>
                <li>
                    <a href="#at-full-reload" aria-label="At full reload">At full reload</a></li></ul>
                </li>
                <li>
                    <a href="#ok-types" aria-label="OK types">OK types</a></li>
                <li>
                    <a href="#problematic-types" aria-label="Problematic types">Problematic types</a></li>
                <li>
                    <a href="#at-least-we-get-a-linter-warning-since-remix-165" aria-label="At least we get a linter warning since remix 1.6.5">At least we get a linter warning since remix 1.6.5</a></li>
                <li>
                    <a href="#how-to-solve-it---stupid-solution" aria-label="How to solve it - stupid solution">How to solve it - stupid solution</a></li>
                <li>
                    <a href="#how-to-solve-it---the-proper-solution" aria-label="How to solve it - the proper solution">How to solve it - the proper solution</a><ul>
                        
                <li>
                    <a href="#new-features-since-remix-165" aria-label="New features since remix 1.6.5">New features since remix 1.6.5</a></li>
                <li>
                    <a href="#remix-typedjson" aria-label="remix-typedjson">remix-typedjson</a></li></ul>
                </li>
                <li>
                    <a href="#what-about-other-remix-api" aria-label="What about other Remix API?">What about other Remix API?</a></li>
                <li>
                    <a href="#could-it-be-solved-with-superjsonhttpsgithubcomblitz-jssuperjson" aria-label="Could it be solved with superjson?">Could it be solved with superjson?</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Last week I made a ⚡️ talk at <a href="https://www.meetup.com/remix-copenhagen/events/285981900/">Remix Copenhagen</a> meetup. I thought I make a short blog post about the content if I already gather the material for it.</p>
<figure class="center-aligned">
    <img loading="lazy" src="/lost-in-translation/lost_in_translation.gif"
         alt="Lost in translation movie"/> 
</figure>

<hr>
<h2 id="there-is-a-mistake-in-this-code-can-you-find-it-">There is a mistake in this code. Can you find it? 🔍<a hidden class="anchor" aria-hidden="true" href="#there-is-a-mistake-in-this-code-can-you-find-it-">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">Note</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@prisma/client&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useCatch</span><span class="p">,</span> <span class="nx">useLoaderData</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@remix-run/react&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">LoaderFunction</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@remix-run/server-runtime&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">json</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@remix-run/server-runtime&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;~/db.server&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">export type Note = {
</span></span></span><span class="line"><span class="cl"><span class="cm">  id: string
</span></span></span><span class="line"><span class="cl"><span class="cm">  title: string
</span></span></span><span class="line"><span class="cl"><span class="cm">  body: string
</span></span></span><span class="line"><span class="cl"><span class="cm">  createdAt: Date
</span></span></span><span class="line"><span class="cl"><span class="cm">  updatedAt: Date
</span></span></span><span class="line"><span class="cl"><span class="cm">}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">LoaderData</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">notes</span>: <span class="kt">Note</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">loader</span>: <span class="kt">LoaderFunction</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">json</span><span class="p">({</span> <span class="nx">notes</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Problem() {</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useLoaderData</span><span class="p">&lt;</span><span class="nt">LoaderData</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span>
</span></span><span class="line"><span class="cl">          <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="na">className</span><span class="o">=</span><span class="s">&#34;p flex flex-auto flex-col p-4 sm:p-6 lg:p-8&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;text-2xl font-bold&#34;</span><span class="p">&gt;{</span><span class="nx">note</span><span class="p">.</span><span class="nx">title</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;text-lg&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">Created</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s1">&#39;en-US&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">Updated</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s1">&#39;en-US&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="nx">Body</span><span class="o">:</span> <span class="p">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">body</span><span class="p">}&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">))}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="-solution">⚠️ Solution<a hidden class="anchor" aria-hidden="true" href="#-solution">#</a></h2>
<p>The problem is with the following lines:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Created</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s2">&#34;en-US&#34;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Updated</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s2">&#34;en-US&#34;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Here, <code>note.createdAt</code> and <code>note.updatedAt</code> will have the type <code>string</code> instead of <code>Date</code>.</p>
<hr>
<h2 id="explanation-">Explanation 📜<a hidden class="anchor" aria-hidden="true" href="#explanation-">#</a></h2>
<h3 id="at-page-navigation">At page navigation<a hidden class="anchor" aria-hidden="true" href="#at-page-navigation">#</a></h3>
<p>The client gets the code-split bundle for that page, and at time <strong>same</strong> time, the loader for that route gets evaluated, which is a <strong>Fetch</strong> request to the server. The response body of that request will be encoded in <code>JSON</code>, so it has to be serializable. Date and some other types don&rsquo;t have a native <code>JSON</code> representation.</p>
<pre tabindex="0"><code>┌────────────┐                       ┌─────────────┐
│     🖥️     ◄───code split bundle───┤     ☁️      │
│  browser   ◄───data from loader────┤   server    │
└────────────┘                       └─────────────┘
</code></pre><p><img loading="lazy" src="/lost-in-translation/navigation.png" alt="Navigation"  />
</p>
<h3 id="at-full-reload">At full reload<a hidden class="anchor" aria-hidden="true" href="#at-full-reload">#</a></h3>
<p>A full reload on the same route will do a full server render, and the data will be just embedded in the HTML. Loaders will be evaluated on the server side, but the data still has to be serializable there too.</p>
<pre tabindex="0"><code>┌────────────┐                       ┌─────────────┐
│     🖥️     ◄───full code bundle────┤     ☁️      │
│  browser   ◄────prefilled html─────┤   server    │
└────────────┘                       └─────────────┘
</code></pre><p><img loading="lazy" src="/lost-in-translation/full_reload.png" alt="Full reload"  />
</p>
<hr>
<h2 id="ok-types">OK types<a hidden class="anchor" aria-hidden="true" href="#ok-types">#</a></h2>
<ul>
<li>✅ string</li>
<li>✅ number</li>
<li>✅ boolean</li>
<li>✅ null</li>
<li>✅ Array</li>
<li>✅ Object</li>
</ul>
<hr>
<h2 id="problematic-types">Problematic types<a hidden class="anchor" aria-hidden="true" href="#problematic-types">#</a></h2>
<ul>
<li>❌ Date</li>
<li>❌ BigInt</li>
<li>❌ Set</li>
<li>❌ Map</li>
<li>❌ RegExp</li>
<li>❌ undefined</li>
<li>❌ Error</li>
<li>❌ NaN</li>
</ul>
<hr>
<h2 id="at-least-we-get-a-linter-warning-since-remix-165">At least we get a linter warning since remix 1.6.5<a hidden class="anchor" aria-hidden="true" href="#at-least-we-get-a-linter-warning-since-remix-165">#</a></h2>
<p><img loading="lazy" src="/lost-in-translation/linter_warning.png" alt="Linter warning"  />
</p>
<hr>
<h2 id="how-to-solve-it---stupid-solution">How to solve it - stupid solution<a hidden class="anchor" aria-hidden="true" href="#how-to-solve-it---stupid-solution">#</a></h2>
<p>Convert the strings to Dates. For this type, it will work fine, as the <code>Date</code>&rsquo;s constructor accepts strings:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Created</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s2">&#34;en-US&#34;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Updated</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s2">&#34;en-US&#34;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>However, there are types in which this method won&rsquo;t work. We need a more generic solution for this.</p>
<hr>
<h2 id="how-to-solve-it---the-proper-solution">How to solve it - the proper solution<a hidden class="anchor" aria-hidden="true" href="#how-to-solve-it---the-proper-solution">#</a></h2>
<h3 id="new-features-since-remix-165">New features since remix 1.6.5<a hidden class="anchor" aria-hidden="true" href="#new-features-since-remix-165">#</a></h3>
<p>&ldquo;We enhanced the type signatures of loader and useLoaderData to make it possible to infer the data type from the return type of its related server function. To enable this feature, you will need to use the LoaderArgs type from your Remix runtime package instead of typing the function directly:&rdquo;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">LoaderFunction</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@remix-run/[runtime]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// --&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">LoaderArgs</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@remix-run/[runtime]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">loader</span>: <span class="kt">LoaderFunction</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">json</span><span class="p">&lt;</span><span class="nt">LoaderData</span><span class="p">&gt;(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// --&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">loader</span><span class="p">(</span><span class="nx">args</span>: <span class="kt">LoaderArgs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">json</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>&ldquo;Then you can infer the loader data by using typeof loader as the type variable in useLoaderData:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">useLoaderData</span><span class="p">()</span> <span class="kr">as</span> <span class="nx">LoaderData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// --&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">useLoaderData</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">loader</span><span class="p">&gt;();</span>
</span></span></code></pre></div><p>With this change, you no longer need to manually define a LoaderData type (huge time and typo saver!), and we serialize all values so that useLoaderData can&rsquo;t return types that are impossible over the network, such as Date objects or functions.&rdquo;</p>
<p>Reference: <a href="https://github.com/remix-run/remix/releases/tag/remix%401.6.5">Remix 1.6.5 release note</a></p>
<h3 id="remix-typedjson">remix-typedjson<a hidden class="anchor" aria-hidden="true" href="#remix-typedjson">#</a></h3>
<p>Drop in replacement for <code>useLoaderData</code>/<code>json</code> calls &ndash;&gt; it will automatically convert your non-serializable types back and forth.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">loaderData</span> <span class="o">=</span> <span class="nx">useLoaderData</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">loader</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// --&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">loaderData</span> <span class="o">=</span> <span class="nx">useTypedLoaderData</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">loader</span><span class="p">&gt;();</span>
</span></span></code></pre></div><p>and</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">json</span><span class="p">({...})</span>
</span></span><span class="line"><span class="cl"><span class="c1">// --&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">return</span> <span class="nx">typedjson</span><span class="p">({...})</span>
</span></span></code></pre></div><p>Adding these two together:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">LoaderArgs</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@remix-run/server-runtime&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">typedjson</span><span class="p">,</span> <span class="nx">useTypedLoaderData</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;remix-typedjson&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">prisma</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;~/db.server&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">loader</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">_</span>: <span class="kt">LoaderArgs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">typedjson</span><span class="p">({</span> <span class="nx">notes</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Problem() {</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useTypedLoaderData</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">loader</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">div</span>
</span></span><span class="line"><span class="cl">          <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="na">className</span><span class="o">=</span><span class="s">&#34;p flex flex-auto flex-col p-4 sm:p-6 lg:p-8&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;text-2xl font-bold &#34;</span><span class="p">&gt;{</span><span class="nx">note</span><span class="p">.</span><span class="nx">title</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;text-lg&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">Created</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s1">&#39;en-US&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">Updated</span> <span class="nx">at</span><span class="o">:</span> <span class="p">{</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">DateTimeFormat</span><span class="p">(</span><span class="s1">&#39;en-US&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="nx">Body</span><span class="o">:</span> <span class="p">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">body</span><span class="p">}&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">))}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This works now as we are sending a <code>__meta__</code> object with the original <code>JSON</code> content, so on the client side the necessary data could be converted to the right type.</p>
<p><img loading="lazy" src="/lost-in-translation/remix_typedjson_resp.png" alt="New response"  />
</p>
<hr>
<h2 id="what-about-other-remix-api">What about other Remix API?<a hidden class="anchor" aria-hidden="true" href="#what-about-other-remix-api">#</a></h2>
<p>Actions and fetchers are affected as well, but remix-typedjson handles them.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">actionData</span> <span class="o">=</span> <span class="nx">useTypedActionData</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">action</span><span class="p">&gt;();</span>
</span></span></code></pre></div><p>and</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fetcher</span> <span class="o">=</span> <span class="nx">useTypedFetcher</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">action</span><span class="p">&gt;();</span>
</span></span></code></pre></div><hr>
<h2 id="could-it-be-solved-with-superjsonhttpsgithubcomblitz-jssuperjson">Could it be solved with <a href="https://github.com/blitz-js/superjson">superjson</a>?<a hidden class="anchor" aria-hidden="true" href="#could-it-be-solved-with-superjsonhttpsgithubcomblitz-jssuperjson">#</a></h2>
<p>Yes, of course.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">deserialize</span><span class="p">,</span> <span class="nx">serialize</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;superjson&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">loader</span>: <span class="kt">LoaderFunction</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">json</span><span class="p">(</span><span class="nx">serialize</span><span class="p">({</span> <span class="nx">notes</span> <span class="p">}));</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Problem() {</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">deserialize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">useLoaderData</span><span class="p">()</span> <span class="kr">as</span> <span class="nx">SuperJSONResult</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="kr">as</span> <span class="nx">LoaderData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>However, <code>remix-typesjson</code>&rsquo;s API is much more comfortable to use, not to mention that it&rsquo;s faster and more lightweight than superjson.</p>
<hr>
<p><a href="https://github.com/joelazar/lost-in-translation">Link</a> for the presentation and code examples.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://joelazar.dev/tags/remix/">Remix</a></li>
      <li><a href="https://joelazar.dev/tags/typescript/">Typescript</a></li>
      <li><a href="https://joelazar.dev/tags/network/">Network</a></li>
      <li><a href="https://joelazar.dev/tags/json/">JSON</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://joelazar.dev/posts/second-post/">
    <span class="title">Next »</span>
    <br>
    <span>Refactored dotfiles</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://joelazar.dev/">joelazar&#39;s personal blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
